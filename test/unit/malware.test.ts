/**
 * Malware database tests
 */


import { 
  hasMalwareHistory, 
  getMalwareDetails, 
  getMalwareInfo,
  getAllMalwarePackages,
  getMalwareDbInfo,
  KNOWN_MALWARE_PACKAGES 
} from '../../src/malware/known-packages.js';

describe('Malware Database', () => {
  describe('hasMalwareHistory', () => {
    it('should detect known malware packages', () => {
      expect(hasMalwareHistory('event-stream')).toBe(true);
      expect(hasMalwareHistory('colors')).toBe(true);
      expect(hasMalwareHistory('faker')).toBe(true);
      expect(hasMalwareHistory('node-ipc')).toBe(true);
    });

    it('should be case-insensitive', () => {
      expect(hasMalwareHistory('Event-Stream')).toBe(true);
      expect(hasMalwareHistory('COLORS')).toBe(true);
    });

    it('should return false for clean packages', () => {
      expect(hasMalwareHistory('lodash')).toBe(false);
      expect(hasMalwareHistory('express')).toBe(false);
      expect(hasMalwareHistory('react')).toBe(false);
    });
  });

  describe('getMalwareDetails', () => {
    it('should return details for known packages', () => {
      const eventStream = getMalwareDetails('event-stream');
      expect(eventStream).toContain('Bitcoin');
      expect(eventStream).toContain('2018');

      const colors = getMalwareDetails('colors');
      expect(colors).toContain('sabotage');
    });

    it('should return null for clean packages', () => {
      expect(getMalwareDetails('lodash')).toBeNull();
    });
  });

  describe('getMalwareInfo', () => {
    it('should return structured info for detailed packages', () => {
      const info = getMalwareInfo('event-stream');
      expect(info).not.toBeNull();
      expect(info?.year).toBe(2018);
      expect(info?.severity).toBe('critical');
      expect(info?.type).toBe('supply-chain');
    });

    it('should include recent 2025 attacks', () => {
      const info = getMalwareInfo('faster_log');
      expect(info).not.toBeNull();
      expect(info?.year).toBe(2025);
    });
  });

  describe('KNOWN_MALWARE_PACKAGES', () => {
    it('should contain significant attack packages', () => {
      const packages = Array.from(KNOWN_MALWARE_PACKAGES);
      expect(packages.length).toBeGreaterThan(20);
      
      // Check categories
      const hasTyposquat = packages.includes('crossenv');
      const hasProtest = packages.includes('node-ipc');
      const hasCrypto = packages.includes('ethers-provider2');
      
      expect(hasTyposquat).toBe(true);
      expect(hasProtest).toBe(true);
      expect(hasCrypto).toBe(true);
    });
  });

  describe('getAllMalwarePackages', () => {
    it('should return array of all package names', () => {
      const packages = getAllMalwarePackages();
      expect(Array.isArray(packages)).toBe(true);
      expect(packages.length).toBeGreaterThan(20);
      expect(packages).toContain('event-stream');
      expect(packages).toContain('colors');
    });
  });

  describe('getMalwareDbInfo', () => {
    it('should return database metadata', () => {
      const info = getMalwareDbInfo();
      expect(info.version).toBeDefined();
      expect(info.lastUpdated).toBeDefined();
      expect(info.count).toBeGreaterThan(20);
    });

    it('should have valid date format for lastUpdated', () => {
      const info = getMalwareDbInfo();
      // Should be YYYY-MM-DD format
      expect(info.lastUpdated).toMatch(/^\d{4}-\d{2}-\d{2}$/);
    });
  });
});
