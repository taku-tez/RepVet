#!/usr/bin/env npx ts-node
/**
 * Update Malware Database Script
 * 
 * Usage:
 *   npx ts-node scripts/update-malware-db.ts add <ecosystem> <package> <description> [options]
 *   npx ts-node scripts/update-malware-db.ts remove <package>
 *   npx ts-node scripts/update-malware-db.ts list [--ecosystem <ecosystem>]
 *   npx ts-node scripts/update-malware-db.ts stats
 * 
 * Examples:
 *   npx ts-node scripts/update-malware-db.ts add npm malicious-pkg "Cryptocurrency stealer" --severity critical --type crypto-stealer --year 2026
 *   npx ts-node scripts/update-malware-db.ts add pypi evil-package "RAT malware" --type supply-chain
 *   npx ts-node scripts/update-malware-db.ts remove malicious-pkg
 *   npx ts-node scripts/update-malware-db.ts list --ecosystem npm
 *   npx ts-node scripts/update-malware-db.ts stats
 */

import { readFileSync, writeFileSync } from 'node:fs';
import { dirname, join } from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const DATA_PATH = join(__dirname, '../data/malware-db.json');

interface MalwareEntry {
  name: string;
  year: number;
  description: string;
  severity: 'critical' | 'high' | 'medium';
  type: 'supply-chain' | 'typosquat' | 'sabotage' | 'protestware' | 'crypto-stealer';
  ecosystem?: string;
}

interface MalwareDb {
  version: string;
  lastUpdated: string;
  packages: MalwareEntry[];
}

function loadDb(): MalwareDb {
  try {
    const data = readFileSync(DATA_PATH, 'utf-8');
    return JSON.parse(data);
  } catch {
    return { version: '1.0.0', lastUpdated: new Date().toISOString().split('T')[0], packages: [] };
  }
}

function saveDb(db: MalwareDb): void {
  db.lastUpdated = new Date().toISOString().split('T')[0];
  writeFileSync(DATA_PATH, JSON.stringify(db, null, 2) + '\n');
  console.log(`‚úÖ Database saved to ${DATA_PATH}`);
}

function parseArgs(args: string[]): { command: string; positional: string[]; options: Record<string, string> } {
  const command = args[0] || 'help';
  const positional: string[] = [];
  const options: Record<string, string> = {};
  
  for (let i = 1; i < args.length; i++) {
    if (args[i].startsWith('--')) {
      const key = args[i].slice(2);
      const value = args[i + 1] && !args[i + 1].startsWith('--') ? args[++i] : 'true';
      options[key] = value;
    } else {
      positional.push(args[i]);
    }
  }
  
  return { command, positional, options };
}

function addPackage(db: MalwareDb, args: string[], options: Record<string, string>): void {
  const [ecosystem, name, description] = args;
  
  if (!ecosystem || !name || !description) {
    console.error('‚ùå Usage: add <ecosystem> <package> <description> [--severity critical|high|medium] [--type supply-chain|typosquat|...] [--year YYYY]');
    process.exit(1);
  }
  
  // Check for duplicate
  const existing = db.packages.find(p => p.name.toLowerCase() === name.toLowerCase());
  if (existing) {
    console.error(`‚ùå Package "${name}" already exists in database`);
    process.exit(1);
  }
  
  const entry: MalwareEntry = {
    name,
    year: parseInt(options.year || String(new Date().getFullYear()), 10),
    description,
    severity: (options.severity as MalwareEntry['severity']) || 'high',
    type: (options.type as MalwareEntry['type']) || 'supply-chain',
  };
  
  // Only add ecosystem if not npm (default)
  if (ecosystem !== 'npm') {
    entry.ecosystem = ecosystem;
  }
  
  db.packages.push(entry);
  saveDb(db);
  
  console.log(`‚úÖ Added: ${name}`);
  console.log(`   Ecosystem: ${ecosystem}`);
  console.log(`   Severity: ${entry.severity}`);
  console.log(`   Type: ${entry.type}`);
  console.log(`   Year: ${entry.year}`);
}

function removePackage(db: MalwareDb, args: string[]): void {
  const [name] = args;
  
  if (!name) {
    console.error('‚ùå Usage: remove <package>');
    process.exit(1);
  }
  
  const idx = db.packages.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
  if (idx === -1) {
    console.error(`‚ùå Package "${name}" not found in database`);
    process.exit(1);
  }
  
  const removed = db.packages.splice(idx, 1)[0];
  saveDb(db);
  
  console.log(`‚úÖ Removed: ${removed.name}`);
}

function listPackages(db: MalwareDb, options: Record<string, string>): void {
  let packages = db.packages;
  
  if (options.ecosystem) {
    const eco = options.ecosystem === 'npm' ? undefined : options.ecosystem;
    packages = packages.filter(p => (p.ecosystem || 'npm') === (eco || 'npm'));
  }
  
  console.log(`üì¶ Malware Database (${packages.length} packages)\n`);
  console.log('Name'.padEnd(45) + 'Year'.padEnd(6) + 'Severity'.padEnd(10) + 'Type');
  console.log('-'.repeat(80));
  
  for (const p of packages.sort((a, b) => b.year - a.year || a.name.localeCompare(b.name))) {
    const eco = p.ecosystem ? ` [${p.ecosystem}]` : '';
    console.log(
      (p.name + eco).padEnd(45) +
      String(p.year).padEnd(6) +
      p.severity.padEnd(10) +
      p.type
    );
  }
}

function showStats(db: MalwareDb): void {
  const byYear: Record<number, number> = {};
  const byType: Record<string, number> = {};
  const bySeverity: Record<string, number> = {};
  const byEcosystem: Record<string, number> = {};
  
  for (const p of db.packages) {
    byYear[p.year] = (byYear[p.year] || 0) + 1;
    byType[p.type] = (byType[p.type] || 0) + 1;
    bySeverity[p.severity] = (bySeverity[p.severity] || 0) + 1;
    const eco = p.ecosystem || 'npm';
    byEcosystem[eco] = (byEcosystem[eco] || 0) + 1;
  }
  
  console.log(`üìä Malware Database Statistics`);
  console.log(`   Version: ${db.version}`);
  console.log(`   Last Updated: ${db.lastUpdated}`);
  console.log(`   Total Packages: ${db.packages.length}\n`);
  
  console.log('By Ecosystem:');
  for (const [eco, count] of Object.entries(byEcosystem).sort((a, b) => b[1] - a[1])) {
    console.log(`   ${eco}: ${count}`);
  }
  
  console.log('\nBy Severity:');
  for (const [sev, count] of Object.entries(bySeverity)) {
    console.log(`   ${sev}: ${count}`);
  }
  
  console.log('\nBy Type:');
  for (const [type, count] of Object.entries(byType).sort((a, b) => b[1] - a[1])) {
    console.log(`   ${type}: ${count}`);
  }
  
  console.log('\nBy Year (recent):');
  for (const year of Object.keys(byYear).map(Number).sort((a, b) => b - a).slice(0, 5)) {
    console.log(`   ${year}: ${byYear[year]}`);
  }
}

function showHelp(): void {
  console.log(`
Malware Database Management Script

Commands:
  add <ecosystem> <package> <description>   Add a new malware entry
    --severity critical|high|medium         Severity level (default: high)
    --type supply-chain|typosquat|...       Attack type (default: supply-chain)
    --year YYYY                             Year discovered (default: current)

  remove <package>                          Remove a package from database

  list [--ecosystem <ecosystem>]            List all packages

  stats                                     Show database statistics

Examples:
  npx ts-node scripts/update-malware-db.ts add npm evil-pkg "Crypto stealer" --severity critical --type crypto-stealer
  npx ts-node scripts/update-malware-db.ts add pypi bad-pkg "RAT malware"
  npx ts-node scripts/update-malware-db.ts remove evil-pkg
  npx ts-node scripts/update-malware-db.ts list --ecosystem npm
  npx ts-node scripts/update-malware-db.ts stats
`);
}

// Main
const { command, positional, options } = parseArgs(process.argv.slice(2));
const db = loadDb();

switch (command) {
  case 'add':
    addPackage(db, positional, options);
    break;
  case 'remove':
    removePackage(db, positional);
    break;
  case 'list':
    listPackages(db, options);
    break;
  case 'stats':
    showStats(db);
    break;
  case 'help':
  default:
    showHelp();
}
