/**
 * Known malware packages database
 * Source: npm advisories, Snyk, Socket.dev, CISA alerts
 * Last updated: 2026-02-04
 */

// Packages that had confirmed malware at some point
export const KNOWN_MALWARE_PACKAGES = new Set([
  // === 2018-2022 Classic Supply Chain Attacks ===
  'event-stream',           // 2018 - Bitcoin wallet stealer
  'flatmap-stream',         // 2018 - event-stream dependency
  'ua-parser-js',           // 2021 - Cryptocurrency miner
  'coa',                    // 2021 - Compromised
  'rc',                     // 2021 - Compromised  
  'colors',                 // 2022 - Intentional sabotage (AMERICAN FLAG)
  'faker',                  // 2022 - Intentional sabotage
  'node-ipc',               // 2022 - Protestware (peacenotwar)
  
  // === Typosquatting Attacks ===
  'crossenv',               // Typosquat of cross-env
  'cross-env.js',           // Typosquat of cross-env
  'mongose',                // Typosquat of mongoose
  'expresss',               // Typosquat of express
  'loadsh',                 // Typosquat of lodash
  'lodashs',                // Typosquat of lodash
  'babelcli',               // Typosquat of babel-cli
  'jquey',                  // Typosquat of jquery
  'electorn',               // Typosquat of electron
  
  // === 2024-2025 Crypto Wallet Attacks ===
  'ethers-provider2',       // 2024 - Wallet drainer
  'ethers-providerz',       // 2024 - Wallet drainer
  '@pika/chalk',            // Malicious fork
  'chalk-next',             // Malicious fork
  
  // === 2025 Ethereum Smart Contract Malware ===
  'colortoolsv2',           // 2025 - Uses Ethereum smart contracts for C2
  'mimelib2',               // 2025 - Uses Ethereum smart contracts for C2
  
  // === 2026 G_Wagon Infostealer Campaign ===
  'ansi-universal-ui',      // 2026 - G_Wagon infostealer, crypto wallet stealer
  
  // === 2025 NodeCordRAT Campaign (Zscaler ThreatLabz) ===
  // Bitcoin-themed packages delivering RAT with Discord C2
  'bitcoin-main-lib',       // 2025 - NodeCordRAT, Discord C2, browser/crypto/token stealer
  'bitcoin-lib-js',         // 2025 - NodeCordRAT, Discord C2, browser/crypto/token stealer
  'bip40',                  // 2025 - NodeCordRAT, Discord C2, browser/crypto/token stealer
  
  // === 2025 September-November "Shai-Hulud" Attack ===
  // Massive supply chain worm targeting npm ecosystem
  // Reference: CISA alert, Socket.dev, Truesec, Wiz, JFrog
  // V1 (Sept 2025): ~40+ packages, @ctrl scope packages
  // V2 (Nov 2025): 700+ packages, 27k GitHub repos, Dead Man's Switch
  // V3 (Dec 2025): @vietmoney scope packages
  
  // Shai-Hulud V1.0 (Sept 2025) - Initial wave
  '@ctrl/tinycolor',                      // V1.0 - 2.2M weekly downloads compromised
  '@ctrl/deluge',                         // V1.0 - Shai-Hulud payload
  '@ctrl/golang-template',                // V1.0 - Shai-Hulud payload
  '@ctrl/magnet-link',                    // V1.0 - Shai-Hulud payload
  '@ctrl/ngx-codemirror',                 // V1.0 - Shai-Hulud payload
  '@ctrl/ngx-csv',                        // V1.0 - Shai-Hulud payload
  '@ctrl/ngx-emoji-mart',                 // V1.0 - Shai-Hulud payload
  '@ctrl/ngx-rightclick',                 // V1.0 - Shai-Hulud payload
  '@ctrl/qbittorrent',                    // V1.0 - Shai-Hulud payload
  '@ctrl/react-adsense',                  // V1.0 - Shai-Hulud payload
  '@ctrl/shared-torrent',                 // V1.0 - Shai-Hulud payload
  '@ctrl/torrent-file',                   // V1.0 - Shai-Hulud payload
  '@ctrl/transmission',                   // V1.0 - Shai-Hulud payload
  '@ctrl/ts-base32',                      // V1.0 - Shai-Hulud payload
  'angulartics2',                         // V1.0 - Shai-Hulud payload
  'json-rules-engine-simplified',         // V1.0 - Shai-Hulud payload
  'koa2-swagger-ui',                      // V1.0 - Shai-Hulud payload
  'ngx-color',                            // V1.0 - Shai-Hulud payload
  'ngx-toastr',                           // V1.0 - Shai-Hulud payload
  'ngx-trend',                            // V1.0 - Shai-Hulud payload
  'ts-gaussian',                          // V1.0 - Shai-Hulud payload
  'react-jsonschema-form-conditionals',   // V1.0 - Shai-Hulud payload
  'react-jsonschema-form-extras',         // V1.0 - Shai-Hulud payload
  'swc-plugin-component-annotate',        // V1.0 - Shai-Hulud payload (CrowdStrike related)
  
  // Shai-Hulud V1.0 - @nativescript-community scope
  '@nativescript-community/gesturehandler', // V1.0 - Shai-Hulud payload
  '@nativescript-community/sentry',       // V1.0 - Shai-Hulud payload
  '@nativescript-community/text',         // V1.0 - Shai-Hulud payload
  '@nativescript-community/ui-collectionview', // V1.0 - Shai-Hulud payload
  '@nativescript-community/ui-drawer',    // V1.0 - Shai-Hulud payload
  '@nativescript-community/ui-image',     // V1.0 - Shai-Hulud payload
  '@nativescript-community/ui-material-bottomsheet', // V1.0 - Shai-Hulud payload
  '@nativescript-community/ui-material-core', // V1.0 - Shai-Hulud payload
  '@nativescript-community/ui-material-core-tabs', // V1.0 - Shai-Hulud payload
  
  // Shai-Hulud V3.0 - @vietmoney scope (Dec 2025)
  '@vietmoney/react-big-calendar',        // V3.0 - confirmed malicious
  '@vietmoney/react-native-smart-page',   // V3.0 - Shai-Hulud payload
  '@vietmoney/react-native-smart-gallery',// V3.0 - Shai-Hulud payload
  '@vietmoney/react-native-true-id',      // V3.0 - Shai-Hulud payload
  '@vietmoney/react-native-tags-input',   // V3.0 - Shai-Hulud payload
  '@vietmoney/react-native-vnpay-merchant', // V3.0 - Shai-Hulud payload
  '@vietmoney/react-native-image-transformer', // V3.0 - Shai-Hulud payload
  '@vietmoney/react-native-htmlview',     // V3.0 - Shai-Hulud payload
  '@vietmoney/react-native-action-button',// V3.0 - Shai-Hulud payload
  '@vietmoney/vietmoneywork',             // V3.0 - Shai-Hulud payload
  '@nativescript-community/perms',        // V2.0 - Shai-Hulud (Nov 2025)
  
  // === PyPI Malware ===
  'num2words',              // 2025 - Phishing attack (versions 0.5.15, 0.5.16)
  'sisaws',                 // 2025 - SilentSync RAT
  'secmeasure',             // 2025 - SilentSync RAT
  'soopsocks',              // 2025 - Malware (2653 downloads)
  'spellcheckers',          // 2025 - Multi-stage backdoor
  'semantic-types',         // 2025 - Solana key stealer (updated Jan 2025)
  
  // === 2026 PyPI RAT Campaign (Aikido) ===
  'spellcheckpy',           // 2026-01 - Python RAT, hidden in eu.json.gz, C2: updatenet.work
  'spellcheckerpy',         // 2026-01 - Python RAT, hidden in eu.json.gz, C2: updatenet.work
  
  // === crates.io Malware ===
  'faster_log',             // 2025 - Typosquat, crypto wallet stealer
  'async_println',          // 2025 - Crypto wallet stealer
  
  // === NuGet Malware (shanhai666 time bomb campaign, Nov 2025) ===
  // Time-delayed sabotage packages targeting databases and industrial PLCs
  // Trigger dates: Aug 2027, Nov 2028
  'MyDbRepository',         // 2023 - shanhai666, time bomb
  'MCDbRepository',         // 2024 - shanhai666, time bomb (Aug 2027 trigger)
  'Sharp7Extend',           // 2024 - shanhai666, ICS/PLC sabotage, typosquat of Sharp7
  'SqlDbRepository',        // 2024 - shanhai666, time bomb
  'SqlRepository',          // 2024 - shanhai666, time bomb
  'SqlUnicornCoreTest',     // 2024 - shanhai666, time bomb (Nov 2028 trigger)
  'SqlUnicornCore',         // 2024 - shanhai666, time bomb (Nov 2028 trigger)
  'SqlUnicorn.Core',        // 2024 - shanhai666, time bomb
  'SqlLiteRepository',      // 2024 - shanhai666, time bomb
  
  // === NuGet Crypto Stealers (2025) ===
  'Tracer.Fody.NLog',       // 2020-2025 - Stratis wallet stealer, typosquat of Tracer.Fody
  'Nethereum.All',          // 2025 - Homoglyph attack (Cyrillic 'ะต'), Ethereum wallet stealer
  'Cleary.AsyncExtensions', // 2023 - Wallet seed phrase stealer, typosquat of AsyncEx
  
  // === Maven Central Malware (Dec 2025) ===
  // Namespace typosquatting: org.fasterxml vs com.fasterxml
  'org.fasterxml.jackson.core:jackson-databind', // 2025 - Cobalt Strike RAT, namespace typosquat
]);

/**
 * Detailed malware information
 */
const MALWARE_DETAILS: Record<string, {
  year: number;
  description: string;
  severity: 'critical' | 'high' | 'medium';
  type: 'supply-chain' | 'typosquat' | 'sabotage' | 'protestware' | 'crypto-stealer';
}> = {
  'event-stream': {
    year: 2018,
    description: 'Bitcoin wallet stealer injected via flatmap-stream dependency',
    severity: 'critical',
    type: 'supply-chain',
  },
  'ua-parser-js': {
    year: 2021,
    description: 'Cryptocurrency miner injection via compromised maintainer account',
    severity: 'critical',
    type: 'supply-chain',
  },
  'colors': {
    year: 2022,
    description: 'Intentional sabotage - infinite loop (AMERICAN FLAG protest)',
    severity: 'high',
    type: 'sabotage',
  },
  'faker': {
    year: 2022,
    description: 'Intentional sabotage by maintainer',
    severity: 'high',
    type: 'sabotage',
  },
  'node-ipc': {
    year: 2022,
    description: 'Protestware - peacenotwar module targeting Russian/Belarusian IPs',
    severity: 'high',
    type: 'protestware',
  },
  'coa': {
    year: 2021,
    description: 'Compromised via maintainer account phishing',
    severity: 'critical',
    type: 'supply-chain',
  },
  'rc': {
    year: 2021,
    description: 'Compromised via maintainer account phishing',
    severity: 'critical',
    type: 'supply-chain',
  },
  'ethers-provider2': {
    year: 2024,
    description: 'Cryptocurrency wallet drainer targeting Ethereum users',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  'num2words': {
    year: 2025,
    description: 'PyPI phishing attack - malicious versions 0.5.15, 0.5.16',
    severity: 'high',
    type: 'supply-chain',
  },
  'faster_log': {
    year: 2025,
    description: 'crates.io typosquat of fast_log - crypto wallet key stealer',
    severity: 'critical',
    type: 'typosquat',
  },
  'async_println': {
    year: 2025,
    description: 'crates.io malicious crate - crypto wallet key stealer',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  'colortoolsv2': {
    year: 2025,
    description: 'Uses Ethereum smart contracts to conceal C2 commands, installs downloader malware',
    severity: 'critical',
    type: 'supply-chain',
  },
  'mimelib2': {
    year: 2025,
    description: 'Uses Ethereum smart contracts to conceal C2 commands, installs downloader malware',
    severity: 'critical',
    type: 'supply-chain',
  },
  'ansi-universal-ui': {
    year: 2026,
    description: 'G_Wagon infostealer - targets 100+ crypto wallets, browser creds, cloud keys',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  // === NodeCordRAT Campaign (Nov 2025) ===
  'bitcoin-main-lib': {
    year: 2025,
    description: 'NodeCordRAT - Discord C2, steals browser data, crypto wallets, Discord tokens',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  'bitcoin-lib-js': {
    year: 2025,
    description: 'NodeCordRAT - Discord C2, steals browser data, crypto wallets, Discord tokens',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  'bip40': {
    year: 2025,
    description: 'NodeCordRAT - Discord C2, steals browser data, crypto wallets, Discord tokens',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  // === Shai-Hulud V1.0 Campaign (Sept 2025) ===
  '@ctrl/tinycolor': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm worm, 2.2M downloads/week, steals npm tokens & cloud creds via TruffleHog',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@ctrl/deluge': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm supply chain worm, credential theft',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@ctrl/ngx-codemirror': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm supply chain worm, credential theft',
    severity: 'critical',
    type: 'supply-chain',
  },
  'angulartics2': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm supply chain worm, credential theft',
    severity: 'critical',
    type: 'supply-chain',
  },
  'ngx-toastr': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm supply chain worm, credential theft',
    severity: 'critical',
    type: 'supply-chain',
  },
  'ngx-color': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm supply chain worm, credential theft',
    severity: 'critical',
    type: 'supply-chain',
  },
  'koa2-swagger-ui': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm supply chain worm, credential theft',
    severity: 'critical',
    type: 'supply-chain',
  },
  'swc-plugin-component-annotate': {
    year: 2025,
    description: 'Shai-Hulud V1.0 - npm supply chain worm, CrowdStrike associated package',
    severity: 'critical',
    type: 'supply-chain',
  },
  // === Shai-Hulud V3.0 Campaign (Dec 2025) ===
  '@vietmoney/react-big-calendar': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm, steals secrets, propagates via npm tokens',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-smart-page': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-smart-gallery': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-true-id': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-tags-input': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-vnpay-merchant': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-image-transformer': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-htmlview': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/react-native-action-button': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@vietmoney/vietmoneywork': {
    year: 2025,
    description: 'Shai-Hulud V3.0 - npm supply chain worm',
    severity: 'critical',
    type: 'supply-chain',
  },
  '@nativescript-community/perms': {
    year: 2025,
    description: 'Shai-Hulud V2.0 - npm supply chain worm with Dead Man Switch',
    severity: 'critical',
    type: 'supply-chain',
  },
  // === 2026 PyPI RAT Campaign (Aikido) ===
  'spellcheckpy': {
    year: 2026,
    description: 'PyPI RAT - payload hidden in eu.json.gz dictionary file, obfuscated exec, C2: updatenet.work',
    severity: 'critical',
    type: 'supply-chain',
  },
  'spellcheckerpy': {
    year: 2026,
    description: 'PyPI RAT - payload hidden in eu.json.gz dictionary file, obfuscated exec, C2: updatenet.work',
    severity: 'critical',
    type: 'supply-chain',
  },
  // === NuGet Malware (shanhai666 time bomb campaign, Nov 2025) ===
  'MyDbRepository': {
    year: 2023,
    description: 'NuGet time bomb - triggers Aug 2027, 20% chance of process termination per DB query',
    severity: 'critical',
    type: 'sabotage',
  },
  'MCDbRepository': {
    year: 2024,
    description: 'NuGet time bomb - triggers Aug 2027, 20% chance of process termination per DB query',
    severity: 'critical',
    type: 'sabotage',
  },
  'Sharp7Extend': {
    year: 2024,
    description: 'NuGet ICS sabotage - typosquat of Sharp7, targets Siemens PLCs, 80% silent write failures, immediate + delayed triggers',
    severity: 'critical',
    type: 'sabotage',
  },
  'SqlDbRepository': {
    year: 2024,
    description: 'NuGet time bomb - targets SQL Server, triggers 2027-2028',
    severity: 'critical',
    type: 'sabotage',
  },
  'SqlRepository': {
    year: 2024,
    description: 'NuGet time bomb - targets SQL Server, triggers 2027-2028',
    severity: 'critical',
    type: 'sabotage',
  },
  'SqlUnicornCoreTest': {
    year: 2024,
    description: 'NuGet time bomb - triggers Nov 2028, 20% chance of process termination',
    severity: 'critical',
    type: 'sabotage',
  },
  'SqlUnicornCore': {
    year: 2024,
    description: 'NuGet time bomb - triggers Nov 2028, 20% chance of process termination',
    severity: 'critical',
    type: 'sabotage',
  },
  'SqlUnicorn.Core': {
    year: 2024,
    description: 'NuGet time bomb - targets databases, delayed activation',
    severity: 'critical',
    type: 'sabotage',
  },
  'SqlLiteRepository': {
    year: 2024,
    description: 'NuGet time bomb - targets SQLite, delayed activation',
    severity: 'critical',
    type: 'sabotage',
  },
  // === NuGet Crypto Stealers (2020-2025) ===
  'Tracer.Fody.NLog': {
    year: 2020,
    description: 'NuGet crypto stealer - typosquat of Tracer.Fody, steals Stratis wallet data, exfiltrates to 176.113.82.163',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  'Nethereum.All': {
    year: 2025,
    description: 'NuGet crypto stealer - homoglyph attack (Cyrillic ะต), steals Ethereum wallet keys',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  'Cleary.AsyncExtensions': {
    year: 2023,
    description: 'NuGet crypto stealer - typosquat of AsyncEx, steals wallet seed phrases',
    severity: 'critical',
    type: 'crypto-stealer',
  },
  // === Maven Central Malware (Dec 2025) ===
  'org.fasterxml.jackson.core:jackson-databind': {
    year: 2025,
    description: 'Maven namespace typosquat - impersonates Jackson JSON library, delivers Cobalt Strike beacon, C2: fasterxml.org',
    severity: 'critical',
    type: 'supply-chain',
  },
};

// Create lowercase versions for case-insensitive matching
const KNOWN_MALWARE_PACKAGES_LOWER = new Set(
  Array.from(KNOWN_MALWARE_PACKAGES).map(p => p.toLowerCase())
);

const MALWARE_DETAILS_LOWER: Record<string, typeof MALWARE_DETAILS[string]> = {};
for (const [key, value] of Object.entries(MALWARE_DETAILS)) {
  MALWARE_DETAILS_LOWER[key.toLowerCase()] = value;
}

/**
 * Check if a package has known malware history
 */
export function hasMalwareHistory(packageName: string): boolean {
  return KNOWN_MALWARE_PACKAGES_LOWER.has(packageName.toLowerCase());
}

/**
 * Get malware details if known
 */
export function getMalwareDetails(packageName: string): string | null {
  const info = MALWARE_DETAILS_LOWER[packageName.toLowerCase()];
  if (info) {
    return `${info.description} (${info.year})`;
  }
  
  // Fallback for packages in the set but without detailed info
  if (KNOWN_MALWARE_PACKAGES_LOWER.has(packageName.toLowerCase())) {
    return 'Known malicious package';
  }
  
  return null;
}

/**
 * Get full malware info
 */
export function getMalwareInfo(packageName: string) {
  return MALWARE_DETAILS_LOWER[packageName.toLowerCase()] || null;
}
