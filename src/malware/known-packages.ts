/**
 * Known malware packages database
 * Source: npm advisories, Snyk, Socket.dev, CISA alerts
 * Data loaded from data/malware-db.json
 */

import { readFileSync } from 'node:fs';
import { dirname, join } from 'node:path';
import { fileURLToPath } from 'node:url';

/**
 * Malware entry type
 */
export interface MalwareEntry {
  name: string;
  year: number;
  description: string;
  severity: 'critical' | 'high' | 'medium';
  type: 'supply-chain' | 'typosquat' | 'sabotage' | 'protestware' | 'crypto-stealer';
  ecosystem?: string;
}

/**
 * Malware database structure
 */
interface MalwareDb {
  version: string;
  lastUpdated: string;
  packages: MalwareEntry[];
}

// Resolve path to data file
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const DATA_PATH = join(__dirname, '../../data/malware-db.json');

/**
 * Load malware database from JSON file
 */
function loadMalwareDb(): MalwareDb {
  try {
    const data = readFileSync(DATA_PATH, 'utf-8');
    return JSON.parse(data) as MalwareDb;
  } catch (error) {
    // Fallback to empty database if file not found
    console.warn(`Warning: Could not load malware database from ${DATA_PATH}`);
    return { version: '0.0.0', lastUpdated: '', packages: [] };
  }
}

// Load database once at module initialization
const malwareDb = loadMalwareDb();

// Build lookup structures
const KNOWN_MALWARE_PACKAGES = new Set(malwareDb.packages.map(p => p.name));
const KNOWN_MALWARE_PACKAGES_LOWER = new Set(
  malwareDb.packages.map(p => p.name.toLowerCase())
);

const MALWARE_DETAILS_LOWER: Record<string, MalwareEntry> = {};
for (const entry of malwareDb.packages) {
  MALWARE_DETAILS_LOWER[entry.name.toLowerCase()] = entry;
}

/**
 * Check if a package has known malware history
 */
export function hasMalwareHistory(packageName: string): boolean {
  return KNOWN_MALWARE_PACKAGES_LOWER.has(packageName.toLowerCase());
}

/**
 * Get malware details if known
 */
export function getMalwareDetails(packageName: string): string | null {
  const info = MALWARE_DETAILS_LOWER[packageName.toLowerCase()];
  if (info) {
    return `${info.description} (${info.year})`;
  }
  
  // Fallback for packages in the set but without detailed info
  if (KNOWN_MALWARE_PACKAGES_LOWER.has(packageName.toLowerCase())) {
    return 'Known malicious package';
  }
  
  return null;
}

/**
 * Get full malware info
 */
export function getMalwareInfo(packageName: string): MalwareEntry | null {
  return MALWARE_DETAILS_LOWER[packageName.toLowerCase()] || null;
}

/**
 * Get all known malware package names
 */
export function getAllMalwarePackages(): string[] {
  return Array.from(KNOWN_MALWARE_PACKAGES);
}

/**
 * Get database metadata
 */
export function getMalwareDbInfo(): { version: string; lastUpdated: string; count: number } {
  return {
    version: malwareDb.version,
    lastUpdated: malwareDb.lastUpdated,
    count: malwareDb.packages.length,
  };
}

// Export for backward compatibility
export { KNOWN_MALWARE_PACKAGES };
